<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GLB Viewer with Camera & Drawer UI</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    #cameraButtons {
      position: absolute; top: 10px; left: 10px;
      background: rgba(0,0,0,0.7); color: white;
      padding: 10px; border-radius: 5px;
      z-index: 10;
    }
    #drawerToggle {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      background: rgba(255,255,255,0.9);
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 10;
    }
    #lightSettings {
      position: absolute; top: 10px; right: 10px;
      background: rgba(0,0,0,0.7); color: white;
      padding: 10px; border-radius: 5px;
      z-index: 10;
    }
    #lightSettings input[type=range] {
      width: 100px;
    }
  </style>
</head>
<body>
  <div id="cameraButtons"></div>
  <div id="drawerToggle">Open</div>
  <div id="lightSettings">
    <label>Brightness: <input id="lightIntensity" type="range" min="0" max="2" step="0.1" value="1"></label>
  </div>
  <script type="module">
    import * as THREE from './js/three.module.js';
    import { GLTFLoader } from './js/GLTFLoader.js';
    import { DRACOLoader } from './js/DRACOLoader.js';
    import { OrbitControls } from './js/OrbitControls.js';

    let camera, scene, renderer, controls, mixer, clock = new THREE.Clock();
    let animations = {}, cameraList = [], currentCamera;
    let drawerObject = null;
    let currentState = 'closed';
    const drawerToggle = document.getElementById('drawerToggle');

    let lights = [];

    init();

    function init() {
      scene = new THREE.Scene();

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      document.body.appendChild(renderer.domElement);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
      camera.position.set(2, 1.5, 2);

      controls = new OrbitControls(camera, renderer.domElement);

      const dracoLoader = new DRACOLoader();
      dracoLoader.setDecoderPath('./js/draco/');

      const loader = new GLTFLoader();
      loader.setDRACOLoader(dracoLoader);

      loader.load('untitled.glb', (gltf) => {
        const model = gltf.scene;
        scene.add(model);

        renderer.physicallyCorrectLights = true;

        // Ambil lampu dari Blender
        model.traverse(obj => {
          if (obj.isLight) {
            lights.push(obj);
          }
        });

        // Animations
        mixer = new THREE.AnimationMixer(model);
        gltf.animations.forEach(clip => {
          animations[clip.name.toLowerCase()] = mixer.clipAction(clip);
          animations[clip.name.toLowerCase()].setLoop(THREE.LoopOnce);
          animations[clip.name.toLowerCase()].clampWhenFinished = true;
        });

        // Cameras
        gltf.cameras?.forEach(cam => cameraList.push(cam));
        createCameraButtons();

        // Drawer object
        drawerObject = model.getObjectByName('drawer') || model;
      });

      document.getElementById('lightIntensity').addEventListener('input', e => {
        lights.forEach(light => light.intensity = parseFloat(e.target.value));
      });

      drawerToggle.addEventListener('click', () => {
        if (currentState === 'closed') {
          playAnim('opendrawer');
          drawerToggle.innerText = 'Close';
          currentState = 'open';
        } else {
          playAnim('closedrawer');
          drawerToggle.innerText = 'Open';
          currentState = 'closed';
        }
      });

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      animate();
    }

    function createCameraButtons() {
      const btnContainer = document.getElementById('cameraButtons');
      btnContainer.innerHTML = '';
      cameraList.forEach((cam, idx) => {
        const btn = document.createElement('button');
        btn.innerText = cam.name || `Camera ${idx+1}`;
        btn.onclick = () => {
          currentCamera = cam;
          controls.object = currentCamera;
          controls.update();
        };
        btnContainer.appendChild(btn);
      });
    }

    function playAnim(name) {
      name = name.toLowerCase();
      if (animations[name]) {
        mixer.stopAllAction();
        animations[name].reset().play();
      }
    }

    function animate() {
      requestAnimationFrame(animate);

      const dt = clock.getDelta();
      mixer?.update(dt);

      // Tampilkan tombol jika dekat drawer
      if (drawerObject) {
        const dist = camera.position.distanceTo(drawerObject.getWorldPosition(new THREE.Vector3()));
        if (dist < 2.5) {
          const pos = drawerObject.getWorldPosition(new THREE.Vector3()).clone().project(camera);
          const x = (pos.x * 0.5 + 0.5) * window.innerWidth;
          const y = (-pos.y * 0.5 + 0.5) * window.innerHeight;
          drawerToggle.style.left = `${x - 40}px`;
          drawerToggle.style.top = `${y - 20}px`;
          drawerToggle.style.display = 'block';
        } else {
          drawerToggle.style.display = 'none';
        }
      }

      renderer.render(scene, currentCamera || camera);
    }
  </script>
</body>
</html>
